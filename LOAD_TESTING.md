# Нагрузочное тестирование с Locust

Этот документ описывает, как запустить нагрузочное тестирование для API глоссария с помощью Locust.

## Установка зависимостей

```bash
pip install -r requirements.txt
```

## Запуск приложения

Перед запуском тестов необходимо запустить FastAPI приложение:

```bash
uvicorn app.main:app --reload
```

Приложение будет доступно по адресу: http://localhost:8000

## Запуск Locust

### Вариант 1: С веб-интерфейсом (рекомендуется)

```bash
locust -f locustfile.py --host=http://localhost:8000
```

После запуска откройте браузер и перейдите по адресу: http://localhost:8089

В веб-интерфейсе вы можете:
- Указать количество пользователей (Number of users)
- Указать скорость создания пользователей (Spawn rate)
- Запустить/остановить тест
- Просматривать статистику в реальном времени
- Скачивать отчеты

### Вариант 2: Headless режим (без веб-интерфейса)

Для автоматизированных тестов можно запустить Locust в headless режиме:

```bash
locust -f locustfile.py --host=http://localhost:8000 \
    --users 100 \
    --spawn-rate 10 \
    --run-time 60s \
    --headless \
    --html report.html
```

Параметры:
- `--users 100` - симулировать 100 одновременных пользователей
- `--spawn-rate 10` - добавлять 10 пользователей в секунду
- `--run-time 60s` - запустить тест на 60 секунд
- `--headless` - запустить без веб-интерфейса
- `--html report.html` - сохранить отчет в HTML файл

## Типы пользователей

В `locustfile.py` определены два типа пользователей:

### 1. GlossaryUser (основной пользователь)
Выполняет все операции CRUD:
- **Чтение списка** (вес: 10) - самая частая операция
- **Получение термина** (вес: 8) - часто используемая операция
- **Создание термина** (вес: 3) - менее частая операция
- **Обновление термина** (вес: 2) - редкая операция
- **Удаление термина** (вес: 1) - самая редкая операция
- **Тест 404 ошибки** (вес: 1) - проверка обработки ошибок

### 2. ReadOnlyUser (пользователь только для чтения)
Выполняет только операции чтения:
- **Чтение списка** (вес: 5)
- **Получение термина** (вес: 3)

## Запуск с определенным типом пользователя

Для тестирования только read-операций:

```bash
locust -f locustfile.py --host=http://localhost:8000 \
    --user-classes ReadOnlyUser
```

Для тестирования с обоими типами пользователей:

```bash
locust -f locustfile.py --host=http://localhost:8000 \
    --user-classes GlossaryUser ReadOnlyUser
```

## Примеры сценариев тестирования

### Легкая нагрузка (разработка)
```bash
locust -f locustfile.py --host=http://localhost:8000 \
    --users 10 \
    --spawn-rate 2 \
    --run-time 30s \
    --headless
```

### Средняя нагрузка
```bash
locust -f locustfile.py --host=http://localhost:8000 \
    --users 50 \
    --spawn-rate 5 \
    --run-time 2m \
    --headless \
    --html report_medium.html
```

### Высокая нагрузка (стресс-тест)
```bash
locust -f locustfile.py --host=http://localhost:8000 \
    --users 200 \
    --spawn-rate 20 \
    --run-time 5m \
    --headless \
    --html report_stress.html
```

### Тест на выносливость (soak test)
```bash
locust -f locustfile.py --host=http://localhost:8000 \
    --users 30 \
    --spawn-rate 3 \
    --run-time 30m \
    --headless \
    --html report_soak.html
```

## Интерпретация результатов

Locust предоставляет следующую статистику:

- **Requests/s** - количество запросов в секунду
- **Response time (ms)** - время отклика
  - Average - среднее время
  - Min/Max - минимальное/максимальное время
  - Median - медианное значение
  - 95th percentile - 95% запросов быстрее этого времени
  - 99th percentile - 99% запросов быстрее этого времени
- **Failures** - количество неудачных запросов
- **RPS** - requests per second (запросов в секунду)

## Метрики производительности

Хорошие показатели для REST API:
- **Response time p95** < 200ms для GET запросов
- **Response time p95** < 500ms для POST/PUT/DELETE запросов
- **Failure rate** < 1%
- **Throughput** зависит от сервера и базы данных

## Распределенное тестирование

Для очень высоких нагрузок можно запустить Locust в распределенном режиме:

**Master:**
```bash
locust -f locustfile.py --master --host=http://localhost:8000
```

**Worker (в отдельных терминалах):**
```bash
locust -f locustfile.py --worker --master-host=localhost
locust -f locustfile.py --worker --master-host=localhost
locust -f locustfile.py --worker --master-host=localhost
```

## Мониторинг приложения во время тестов

Рекомендуется мониторить следующие метрики:
- CPU и память приложения
- Количество активных соединений к БД
- Время выполнения SQL запросов
- Логи ошибок приложения

## Советы по оптимизации

Если тесты показывают низкую производительность:

1. **Оптимизация БД**:
   - Добавьте индексы на часто используемые поля (keyword)
   - Используйте connection pooling
   - Оптимизируйте SQL запросы

2. **Оптимизация приложения**:
   - Используйте кеширование для часто запрашиваемых данных
   - Настройте workers в uvicorn: `uvicorn app.main:app --workers 4`
   - Рассмотрите использование асинхронных операций

3. **Инфраструктура**:
   - Масштабируйте горизонтально (несколько инстансов приложения)
   - Используйте load balancer
   - Оптимизируйте настройки БД

## Troubleshooting

**Проблема**: Connection errors во время теста
**Решение**: Увеличьте лимиты соединений в ОС и uvicorn

**Проблема**: Тесты работают медленно локально
**Решение**: Это нормально для локальной разработки. Тестируйте на production-like окружении

**Проблема**: Много 409 (Conflict) ошибок
**Решение**: Это ожидаемо при попытке создать термины с одинаковыми keywords. Locust генерирует случайные данные.
